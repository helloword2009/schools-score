<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏Ñ‡∏ì‡∏∞‡∏¢‡∏≠‡∏î‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå</title>
  <link rel="stylesheet" href="summary.css">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>
  <header>
    <h1>‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏Ñ‡∏ì‡∏∞‡∏¢‡∏≠‡∏î‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå</h1>
  </header>

  <main>
    <div id="winnerBox" class="winner-box"></div>

    <table id="summaryTable">
      <thead>
        <tr>
          <th>‡∏Ñ‡∏ì‡∏∞‡∏™‡∏µ</th>
          <th>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏°</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </main>

  <footer>
    <p>¬© ‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏™‡∏ï‡∏£‡∏µ‡∏ô‡∏Ñ‡∏£‡∏™‡∏ß‡∏£‡∏£‡∏Ñ‡πå | <a href="report.html">‡∏û‡∏¥‡∏°‡∏û‡πå‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</a></p>
  </footer>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyDwmeumgDSVlspe7gIcF6rVbe-hBye7Q3I",
    authDomain: "school-scores-8e9eb.firebaseapp.com",
    databaseURL: "https://school-scores-8e9eb-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "school-scores-8e9eb",
    storageBucket: "school-scores-8e9eb.firebasestorage.app",
    messagingSenderId: "416720346956",
    appId: "1:416720346956:web:b20e84af0b635b374279e9",
    measurementId: "G-DD7E1RFNC1"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  const FACULTIES = ["‡∏°‡∏≤‡∏•‡∏±‡∏¢‡∏û‡∏¥‡∏£‡∏∏‡∏ì","‡πÑ‡∏û‡∏à‡∏¥‡∏ï‡πÄ‡∏ß‡∏´‡∏≤‡∏™","‡πÇ‡∏≠‡∏†‡∏≤‡∏™‡∏£‡∏ß‡∏µ","‡∏à‡∏±‡∏ô‡∏ó‡∏£‡∏≤‡∏≠‡∏≥‡πÑ‡∏û","‡∏£‡∏±‡∏®‡∏°‡∏µ‡∏î‡∏≤‡∏£‡∏≤"];

  const CLASSROOMS = {
    "‡∏°‡∏≤‡∏•‡∏±‡∏¢‡∏û‡∏¥‡∏£‡∏∏‡∏ì": ["1/4","1/9","2/5","2/10","3/1","3/6","3/11","4/1","4/6","4/11","5/2","5/12","6/2","6/7","6/12"],
    "‡πÑ‡∏û‡∏à‡∏¥‡∏ï‡πÄ‡∏ß‡∏´‡∏≤‡∏™": ["1/5","1/10","2/1","2/6","2/11","3/2","3/7","3/12","4/2","4/12","5/3","5/8","6/3","6/8","6/11"],
    "‡πÇ‡∏≠‡∏†‡∏≤‡∏™‡∏£‡∏ß‡∏µ": ["1/1","1/6","1/11","2/2","2/7","3/3","3/8","4/3","4/8","4/13","5/4","5/9","5/11","6/4","6/9"],
    "‡∏à‡∏±‡∏ô‡∏ó‡∏£‡∏≤‡∏≠‡∏≥‡πÑ‡∏û": ["1/3","1/8","1/13","2/4","2/9","3/5","3/10","4/5","4/7","4/10","5/1","5/6","6/5","6/6","6/13"],
    "‡∏£‡∏±‡∏®‡∏°‡∏µ‡∏î‡∏≤‡∏£‡∏≤": ["1/2","1/7","1/12","2/3","2/8","2/13","3/4","3/9","4/4","4/9","5/5","5/7","5/10","5/13","6/1","6/10"]
  };

  const TYPE_LATE = "‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏°‡∏≤‡∏™‡∏≤‡∏¢";
  const TYPE_LINEUP = "‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡πÅ‡∏ñ‡∏ß";
  const TYPE_CLEAN = "‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏≠‡∏≤‡∏î";
  const LATE_RANK_SCORES = [9, 8, 7, 6, 5];

  db.ref("scores").on("value", (snapshot) => {
    const data = snapshot.val() || {};

    const totals = {};
    const lateCounts = {};
    const lateHasData = {};     // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°
    const lineupTotals = {};
    const cleanTotals = {};

    FACULTIES.forEach(f => {
      totals[f] = 0;
      lateCounts[f] = 0;
      lateHasData[f] = false;  // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°
      lineupTotals[f] = 0;
      cleanTotals[f] = 0;
    });

    for (const key in data) {
      const item = data[key] || {};
      const faculty = (item.faculty || "").trim();
      if (!FACULTIES.includes(faculty)) continue;

      const val = Number(item.value) || 0;

      if (item.type === TYPE_LATE) {
        lateCounts[faculty] += val;
        lateHasData[faculty] = true; // ‚úÖ ‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏°‡∏≤‡∏™‡∏≤‡∏¢‡∏à‡∏£‡∏¥‡∏á
      } else if (item.type === TYPE_LINEUP) {
        lineupTotals[faculty] += val;
      } else if (item.type === TYPE_CLEAN) {
        cleanTotals[faculty] += val;
      }
    }

    // ‡∏£‡∏ß‡∏°‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡πÅ‡∏ñ‡∏ß + ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏≠‡∏≤‡∏î‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏ï‡∏≤‡∏°‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏´‡πâ‡∏≠‡∏á
    FACULTIES.forEach(f => {
      totals[f] += lineupTotals[f];
      const roomCount = CLASSROOMS[f]?.length || 0;
      totals[f] += roomCount > 0 ? (cleanTotals[f] / roomCount) : 0;
    });

    // ‚úÖ ‡∏à‡∏±‡∏î‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡∏°‡∏≤‡∏™‡∏≤‡∏¢: ‡∏Ñ‡∏ì‡∏∞‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• => Infinity (‡πÑ‡∏õ‡∏ó‡πâ‡∏≤‡∏¢‡∏™‡∏∏‡∏î)
    const sortedByLate = FACULTIES
      .map(f => [f, lateHasData[f] ? lateCounts[f] : Number.POSITIVE_INFINITY])
      .sort((a, b) => a[1] - b[1]);

    // ‡πÅ‡∏à‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏°‡∏≤‡∏™‡∏≤‡∏¢‡∏ï‡∏≤‡∏°‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö (‡∏ô‡πâ‡∏≠‡∏¢‡∏î‡∏µ‡∏Å‡∏ß‡πà‡∏≤)
    sortedByLate.forEach(([f], idx) => {
      const lateScore = LATE_RANK_SCORES[Math.min(idx, LATE_RANK_SCORES.length - 1)];
      totals[f] += lateScore;
    });

    // ‡∏´‡∏≤ winner
    let winner = null;
    let maxScore = -Infinity;
    FACULTIES.forEach(f => {
      if (totals[f] > maxScore) {
        maxScore = totals[f];
        winner = f;
      }
    });

    const winnerBox = document.getElementById("winnerBox");
    if (winner && isFinite(maxScore)) {
      winnerBox.innerHTML = `üèÜ <strong>${winner}</strong> ‡πÑ‡∏î‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏ì‡∏∞‡∏¢‡∏≠‡∏î‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå ‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏° ${maxScore.toFixed(2)} ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô`;
    } else {
      winnerBox.innerHTML = "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÉ‡∏ô‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏ô‡∏µ‡πâ";
    }

    // ‡πÄ‡∏ï‡∏¥‡∏°‡∏ï‡∏≤‡∏£‡∏≤‡∏á
    const tbody = document.querySelector("#summaryTable tbody");
    tbody.innerHTML = "";
    FACULTIES.forEach(f => {
      const row = document.createElement("tr");
      row.innerHTML = `<td>${f}</td><td>${(totals[f] || 0).toFixed(2)}</td>`;
      tbody.appendChild(row);
    });
  });
</script>
</body>
</html>
