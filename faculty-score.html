<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏Ñ‡∏ì‡∏∞‡∏™‡∏µ</title>
  <link rel="stylesheet" href="faculty-score.css">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>
  <header>
    <h1 id="facultyTitle">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏Ñ‡∏ì‡∏∞‡∏™‡∏µ</h1>
  </header>

  <main>
    <!-- ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó -->
    <section>
      <h2>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏°‡∏≤‡∏™‡∏≤‡∏¢</h2>
      <div class="table-wrapper">
        <table>
          <thead>
            <tr>
              <th>‡πÄ‡∏ß‡∏•‡∏≤</th>
              <th>‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</th>
              <th>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</th>
              <th>‡∏£‡∏π‡∏õ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</th>
              <th>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</th>
            </tr>
          </thead>
          <tbody id="lateTable"></tbody>
        </table>
      </div>
    </section>

    <section>
      <h2>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡πÅ‡∏ñ‡∏ß</h2>
      <div class="table-wrapper">
        <table>
          <thead>
            <tr>
              <th>‡πÄ‡∏ß‡∏•‡∏≤</th>
              <th>‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</th>
              <th>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</th>
              <th>‡∏£‡∏π‡∏õ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</th>
              <th>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</th>
            </tr>
          </thead>
          <tbody id="lineTable"></tbody>
        </table>
      </div>
    </section>

    <section>
      <h2>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏≠‡∏≤‡∏î</h2>
      <div class="table-wrapper">
        <table>
          <thead>
            <tr>
              <th>‡πÄ‡∏ß‡∏•‡∏≤</th>
              <th>‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</th>
              <th>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</th>
              <th>‡∏£‡∏π‡∏õ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</th>
              <th>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</th>
            </tr>
          </thead>
          <tbody id="cleanTable"></tbody>
        </table>
      </div>
    </section>

    <!-- ‡∏™‡∏£‡∏∏‡∏õ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏° -->
    <div class="summary" id="summaryBox"></div>
  </main>

  <div class="action-buttons">
    <button class="back-btn" onclick="window.location.href='summary.html'">
      ‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏Ñ‡∏ì‡∏∞‡∏¢‡∏≠‡∏î‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå
    </button>
  </div>

  <footer>
    <p>¬© ‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏™‡∏ï‡∏£‡∏µ‡∏ô‡∏Ñ‡∏£‡∏™‡∏ß‡∏£‡∏£‡∏Ñ‡πå</p>
  </footer>

  <!-- popup ‡∏£‡∏π‡∏õ -->
  <div id="imagePopup" onclick="closePopup()">
    <img id="popupImage" src="">
  </div>

  <!-- üîß ‡πÄ‡∏û‡∏¥‡πà‡∏° Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

  <script>
    const params = new URLSearchParams(window.location.search);
    const facultyName = params.get("faculty");
    document.getElementById("facultyTitle").innerText = "‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏Ñ‡∏ì‡∏∞‡∏™‡∏µ " + facultyName;

    // üîß ‡∏•‡∏ö localStorage ‡∏≠‡∏≠‡∏Å ‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏ä‡πâ Firebase ‡πÅ‡∏ó‡∏ô
    // let history = JSON.parse(localStorage.getItem("scoreHistory")) || [];
    // let facultyHistory = history.filter(item => item.faculty === facultyName);

    let total = 0;
    let totalsByType = { "‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏°‡∏≤‡∏™‡∏≤‡∏¢": 0, "‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡πÅ‡∏ñ‡∏ß": 0, "‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏≠‡∏≤‡∏î": 0 };

    // üîß Firebase Config
    const firebaseConfig = {
      apiKey: "AIzaSyDwmeumgDSVlspe7gIcF6rVbe-hBye7Q3I",
      authDomain: "school-scores-8e9eb.firebaseapp.com",
      databaseURL: "https://school-scores-8e9eb-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "school-scores-8e9eb",
      storageBucket: "school-scores-8e9eb.firebasestorage.app",
      messagingSenderId: "416720346956",
      appId: "1:416720346956:web:b20e84af0b635b374279e9",
      measurementId: "G-DD7E1RFNC1"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // üîß render ‡∏à‡∏≤‡∏Å Firebase
    function renderByType(type, tableId) {
      db.ref("scores").orderByChild("faculty").equalTo(facultyName).on("value", (snapshot) => {
        const data = snapshot.val() || {};
        const tbody = document.getElementById(tableId);
        tbody.innerHTML = "";

        totalsByType[type] = 0; // reset ‡∏Å‡πà‡∏≠‡∏ô‡∏£‡∏ß‡∏°‡πÉ‡∏´‡∏°‡πà

        Object.keys(data).forEach((key) => {
          const item = data[key];
          if (item.type === type) {
            totalsByType[type] += item.value;
            total += item.value;

            const row = document.createElement("tr");
            row.innerHTML = `
              <td>${item.time}</td>
              <td>${item.classroom}</td>
              <td>${item.value}</td>
              <td>${item.image ? `<img src="${item.image}" class="activity-img" onclick="openImagePopup('${item.image}')">` : "-"}</td>
              <td><button onclick="editScore('${key}', ${item.value})">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button></td>
            `;
            tbody.appendChild(row);
          }
        });

        updateSummary();
      });
    }

    // üîß ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÉ‡∏ô Firebase
    function editScore(key, oldValue) {
      const newValue = prompt("‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô:", oldValue);
      if (newValue !== null && !isNaN(newValue)) {
        db.ref("scores/" + key).update({ value: parseInt(newValue) });
        alert("‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß ‚úÖ");
      }
    }

    // üîß ‡∏™‡∏£‡∏∏‡∏õ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏°
    function updateSummary() {
      total = 0;
      for (const type in totalsByType) {
        total += totalsByType[type];
      }

      const summaryBox = document.getElementById("summaryBox");
      summaryBox.innerHTML = "";
      for (const type in totalsByType) {
        const card = document.createElement("div");
        card.className = "summary-card";
        card.innerHTML = `<h3>${type}</h3><p>${totalsByType[type]} ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</p>`;
        summaryBox.appendChild(card);
      }
      const totalCard = document.createElement("div");
      totalCard.className = "summary-card total";
      totalCard.innerHTML = `<h3>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h3><p>${total} ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</p>`;
      summaryBox.appendChild(totalCard);
    }

    // popup ‡∏£‡∏π‡∏õ
    function openImagePopup(src) {
      document.getElementById("popupImage").src = src;
      document.getElementById("imagePopup").style.display = "block";
    }
    function closePopup() {
      document.getElementById("imagePopup").style.display = "none";
    }

    // üîß ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å render ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó
    renderByType("‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏°‡∏≤‡∏™‡∏≤‡∏¢", "lateTable");
    renderByType("‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡πÅ‡∏ñ‡∏ß", "lineTable");
    renderByType("‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏≠‡∏≤‡∏î", "cleanTable");
  </script>
</body>
</html>
